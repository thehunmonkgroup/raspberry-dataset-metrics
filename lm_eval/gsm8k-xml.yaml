# lm_eval/tasks/gsm8k/gsm8k-xml.yaml
include: gsm8k.yaml
task: gsm8k_xml

# 1) Re-split the `answer` variable into chain vs final-answer:
doc_to_text: "Question: {{question}}\nAnswer:"
doc_to_target: |
  <reasoning>{{ answer.split('#### ')[0].strip() }}</reasoning>
  <output>#### {{ answer.split('#### ')[1].strip() }}</output>

# 2) Mirror the base strict-match/flexible-extract filters, but scoped inside <output>â€¦</output>:
filter_list:
  - name: strict-match
    filter:
      - function: regex
        # exactly ####<number> inside the XML tags
        regex_pattern: "<output>\\s*#### (\\-?[0-9\\.\\,]+)\\s*<\\/output>"
      - function: take_first

  - name: flexible-extract
    filter:
      - function: regex
        # fallback currency/number matcher inside the XML tags
        regex_pattern: "<output>(?:(?!(-?[$0-9.,]{2,})|(-?[0-9]+)).)*((-?[$0-9.,]{2,})|(-?[0-9]+))(?:(?!(-?[$0-9.,]{2,})|(-?[0-9]+)).)*<\\/output>"
        group_select: -1
      - function: take_first

metric_list:
  - metric: exact_match
    aggregation: mean
    higher_is_better: true
    ignore_case: true
    ignore_punctuation: false
    regexes_to_ignore:
      - "<\\/?reasoning>.*?<\\/reasoning>"
      - "<\\/?output>"
      - "\\n|\\r\\n|\\r"
      - ","
      - "\\$"
      - "(?s).*#### "
      - "\\.$"
